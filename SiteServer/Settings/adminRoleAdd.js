var $api=new apiUtils.Api(apiUrl+"/pages/settings/adminRoleAdd"),$roleId=pageUtils.getQueryInt("roleId"),data={pageLoad:!1,pageAlert:null,pageType:null,roleName:null,description:null,permissions:null,allPermissions:null,checkedPermissions:null,systemCheckAll:!1,isSystemIndeterminate:!0,siteInfoList:null,checkedSiteIdList:null,siteInfo:null,permissionInfo:null},methods={getConfig:function(){var i=this;$api.get({roleId:$roleId},function(s,e){if(!s&&e&&e.value){e.roleInfo&&(i.roleName=e.roleInfo.roleName,i.description=e.roleInfo.description),i.permissions=e.permissions,i.checkedPermissions=[],i.allPermissions=[];for(var n=0;n<e.permissions.length;n++)i.allPermissions.push(e.permissions[n].name),e.permissions[n].selected&&i.checkedPermissions.push(e.permissions[n].name);i.siteInfoList=e.siteInfoList,i.checkedSiteIdList=e.checkedSiteIdList||[];for(n=0;n<e.sitePermissionsList.length;n++)for(var t=i.getPermissionInfo(e.sitePermissionsList[n]),o=0;o<e.siteInfoList.length;o++){var r=e.siteInfoList[o];r.id===t.siteId&&(r.permissionInfo=t)}i.pageType="role",i.pageLoad=!0}})},handleSystemCheckAllChange:function(i){if(this.checkedPermissions=[],i)for(var s=0;s<this.permissions.length;s++)this.checkedPermissions.push(this.permissions[s].name);this.isSystemIndeterminate=!1},handleCheckedPermissionsChange:function(i){var s=i.length;this.systemCheckAll=s===this.permissions.length,this.isSystemIndeterminate=s>0&&s<this.permissions.length},getPermissionText:function(i){for(var s=0;s<this.permissions.length;s++)if(this.permissions[s].name===i)return this.permissions[s].text;return""},getPermissionInfo:function(i){for(var s=i.sitePermissions,e=[],n=[],t=0;t<i.sitePermissions.length;t++)n.push(i.sitePermissions[t].name),i.sitePermissions[t].selected&&e.push(i.sitePermissions[t].name);var o=i.pluginPermissions,r=[],h=[];for(t=0;t<i.pluginPermissions.length;t++)h.push(i.pluginPermissions[t].name),i.pluginPermissions[t].selected&&r.push(i.pluginPermissions[t].name);var l=i.channelPermissions,m=[],a=[];for(t=0;t<i.channelPermissions.length;t++)a.push(i.channelPermissions[t].name),i.channelPermissions[t].selected&&m.push(i.channelPermissions[t].name);var c=i.channelInfo,p=i.checkedChannelIdList||[];return{siteId:i.value,sitePermissions:s,siteCheckAll:!1,isSiteIndeterminate:!0,allSitePermissions:n,checkedSitePermissions:e,pluginPermissions:o,pluginCheckAll:!1,isPluginIndeterminate:!0,allPluginPermissions:h,checkedPluginPermissions:r,channelPermissions:l,channelCheckAll:!1,isChannelIndeterminate:!0,allChannelPermissions:a,checkedChannelPermissions:m,channelInfo:c,checkedChannelIdList:p}},btnPermissionClick:function(i){if(this.siteInfo=i,this.siteInfo.permissionInfo)return this.permissionInfo=this.siteInfo.permissionInfo,void(this.pageType="permissions");pageUtils.loading(!0);var s=this;$api.getAt(this.siteInfo.id,{roleId:$roleId},function(i,e){pageUtils.loading(!1),!i&&e&&e.value&&(s.siteInfo.permissionInfo=s.getPermissionInfo(e),s.permissionInfo=s.siteInfo.permissionInfo,s.pageType="permissions")})},handleSiteCheckAllChange:function(i){if(this.permissionInfo.checkedSitePermissions=[],i)for(var s=0;s<this.permissionInfo.sitePermissions.length;s++)this.permissionInfo.checkedSitePermissions.push(this.permissionInfo.sitePermissions[s].name);this.permissionInfo.isSiteIndeterminate=!1},handleCheckedSitePermissionsChange:function(i){var s=i.length;this.permissionInfo.siteCheckAll=s===this.permissionInfo.sitePermissions.length,this.permissionInfo.isSiteIndeterminate=s>0&&s<this.permissionInfo.sitePermissions.length},getSitePermissionText:function(i){for(var s=0;s<this.permissionInfo.sitePermissions.length;s++)if(this.permissionInfo.sitePermissions[s].name===i)return this.permissionInfo.sitePermissions[s].text;return""},handlePluginCheckAllChange:function(i){if(this.permissionInfo.checkedPluginPermissions=[],i)for(var s=0;s<this.permissionInfo.pluginPermissions.length;s++)this.permissionInfo.checkedPluginPermissions.push(this.permissionInfo.pluginPermissions[s].name);this.permissionInfo.isPluginIndeterminate=!1},handleCheckedPluginPermissionsChange:function(i){var s=i.length;this.permissionInfo.pluginCheckAll=s===this.permissionInfo.pluginPermissions.length,this.permissionInfo.isPluginIndeterminate=s>0&&s<this.permissionInfo.pluginPermissions.length},getPluginPermissionText:function(i){for(var s=0;s<this.permissionInfo.pluginPermissions.length;s++)if(this.permissionInfo.pluginPermissions[s].name===i)return this.permissionInfo.pluginPermissions[s].text;return""},handleChannelCheckAllChange:function(i){if(this.permissionInfo.checkedChannelPermissions=[],i)for(var s=0;s<this.permissionInfo.channelPermissions.length;s++)this.permissionInfo.checkedChannelPermissions.push(this.permissionInfo.channelPermissions[s].name);this.permissionInfo.isChannelIndeterminate=!1},handleTreeChanged:function(){this.permissionInfo.checkedChannelIdList=this.$refs.tree.getCheckedKeys()},handleCheckedChannelPermissionsChange:function(i){var s=i.length;this.permissionInfo.channelCheckAll=s===this.permissionInfo.channelPermissions.length,this.permissionInfo.isChannelIndeterminate=s>0&&s<this.permissionInfo.channelPermissions.length},getChannelPermissionText:function(i){for(var s=0;s<this.permissionInfo.channelPermissions.length;s++)if(this.permissionInfo.channelPermissions[s].name===i)return this.permissionInfo.channelPermissions[s].text;return""},apiSubmit:function(){var i=this;pageUtils.loading(!0);for(var s=[],e=0;e<this.siteInfoList.length;e++){var n=this.siteInfoList[e];n.permissionInfo&&s.push({siteId:n.id,channelIdCollection:_.join(n.permissionInfo.checkedChannelIdList,","),channelPermissions:_.join(n.permissionInfo.checkedChannelPermissions,","),websitePermissions:_.join(_.union(n.permissionInfo.checkedSitePermissions,n.permissionInfo.checkedPluginPermissions),",")})}$roleId>0?$api.putAt($roleId,{roleName:this.roleName,description:this.description,generalPermissions:this.checkedPermissions,sitePermissions:s},function(s,e){pageUtils.loading(!1),s?i.pageAlert={type:"danger",html:s.message}:(i.pageAlert={type:"success",html:"角色保存成功！"},setTimeout(function(){location.href="adminRole.cshtml"},1e3))}):$api.post({roleName:this.roleName,description:this.description,generalPermissions:this.checkedPermissions,sitePermissions:s},function(s,e){pageUtils.loading(!1),s?i.pageAlert={type:"danger",html:s.message}:(i.pageAlert={type:"success",html:"角色保存成功！"},setTimeout(function(){location.href="adminRole.cshtml"},1e3))})},btnSaveClick:function(){var i=this;this.$validator.validate().then(function(s){s&&i.apiSubmit()})},btnReturnClick:function(){location.href="adminRole.cshtml"},btnSubmitClick:function(){-1===this.checkedSiteIdList.indexOf(this.siteInfo.id)&&this.checkedSiteIdList.push(this.siteInfo.id),this.pageType="role"},btnCancelClick:function(){this.pageType="role"}};new Vue({el:"#main",data:data,methods:methods,created:function(){this.getConfig()}});
var $api=new apiUtils.Api(apiUrl+"/pages/cms/specialAddLayer"),$uploadUrl=apiUrl+"/pages/cms/specialAddLayer";function formatDate(){var e=new Date,t=""+(e.getMonth()+1),i=""+e.getDate(),a=e.getFullYear();return t.length<2&&(t="0"+t),i.length<2&&(i="0"+i),[a,t,i].join("-")}var data={siteId:parseInt(pageUtils.getQueryString("siteId")),specialId:pageUtils.getQueryString("specialId"),isEditOnly:pageUtils.getQueryBoolean("isEditOnly"),isUploadOnly:pageUtils.getQueryBoolean("isUploadOnly"),guid:null,pageLoad:!1,pageAlert:null,title:null,url:"/special/"+formatDate(),file:null,files:[],checkedLevel:null,isOverride:!1,uploading:!1},methods={getConfig:function(){var e=this;$api.get({siteId:e.siteId,specialId:e.specialId},function(t,i){!t&&i&&(i.value&&(e.title=i.value.title,e.url=i.value.url),e.guid=i.guid,e.pageLoad=!0,e.isEditOnly||setTimeout(function(){e.loadUploader()},200))})},loadUploader:function(){var e=this,t=Q.event,i=Q.Uploader,a=document.getElementById("drop-area"),l=new i({url:$uploadUrl+"/actions/upload?siteId="+this.siteId+"&guid="+this.guid,target:document.getElementById("drop-area"),on:{add:function(t){e.uploading=!0},complete:function(t){e.uploading=!1;var i=t.json;if(!i||1!=i.ret)return alert({title:"文件上传失败！",type:"error",showConfirmButton:!1});i&&i.fileName&&e.files.push(i)}}});i.support.html5&&l.html5?(t.add(a,"dragleave",t.stop),t.add(a,"dragenter",t.stop),t.add(a,"dragover",t.stop),t.add(a,"drop",function(e){t.stop(e);var i=e.dataTransfer.files;l.addList(i)})):a.innerHTML="点击批量上传文件"},del:function(e){this.files.splice(this.files.indexOf(e),1)},getFileNames:function(){for(var e=[],t=0;t<this.files.length;t++)e.push(this.files[t].fileName);return e},btnSubmitClick:function(){var e=this;this.$validator.validate().then(function(t){t&&e.submit()})},submit:function(){var e=this;this.pageAlert=null;var t=this.getFileNames().join(",");if(!e.isEditOnly&&!t)return alert({title:"请选择专题文件！",type:"warning",showConfirmButton:!1});parent.pageUtils.loading(!0),$api.post({siteId:this.siteId,guid:this.guid,specialId:this.specialId,isEditOnly:this.isEditOnly,isUploadOnly:this.isUploadOnly,title:this.title,url:this.url,fileNames:t},function(t,i){if(parent.pageUtils.loading(!1),t)return e.pageAlert={type:"danger",html:t.message};parent.location.reload(!0)})},btnCancelClick:function(){pageUtils.closeLayer()}};new Vue({el:"#main",data:data,methods:methods,created:function(){this.getConfig()}});